name: Publish Foundry module assets

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish-assets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Package module assets
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          shopt -s nullglob
          for manifest in */module.json; do
            module_dir="$(dirname "$manifest")"
            module_id="$(python -c "import json;print(json.load(open('$manifest', encoding='utf-8'))['id'])")"

            echo "Packaging ${module_id} from ${module_dir}"

            python -m json.tool "$manifest" > /dev/null
            cp "$manifest" "dist/${module_id}-module.json"

            MODULE_DIR="$module_dir" MODULE_ID="$module_id" python - <<'PY'
            import json
            import os
            import re
            import urllib.request

            module_dir = os.environ["MODULE_DIR"]
            module_id = os.environ["MODULE_ID"]

            with open(f"{module_dir}/module.json", encoding="utf-8") as handle:
              manifest = json.load(handle)

            verified = str(manifest.get("compatibility", {}).get("verified", "")).strip()
            if not verified or "." not in verified:
              raise SystemExit(f"Missing or invalid compatibility.verified in {module_dir}/module.json")

            with urllib.request.urlopen("https://foundryvtt.com/releases/") as response:
              releases_html = response.read().decode("utf-8", errors="ignore")

            stable_versions = []
            stable_pattern = re.compile(r"Release\s+(\d+\.\d+).*?(?:Update|Full)\s+Stable", re.IGNORECASE | re.DOTALL)
            for match in stable_pattern.findall(releases_html):
              major_str, minor_str = match.split(".", 1)
              stable_versions.append((int(major_str), int(minor_str), match))

            if not stable_versions:
              raise SystemExit("Unable to determine Foundry stable releases from https://foundryvtt.com/releases/")

            latest_major, latest_minor, latest_stable = max(stable_versions)

            verified_major_str, verified_minor_str = verified.split(".", 1)
            verified_major = int(verified_major_str)
            verified_minor = int(verified_minor_str)

            if verified_major == latest_major and verified_minor == latest_minor:
              color = "brightgreen"
            elif verified_major == latest_major:
              color = "yellow"
            else:
              color = "red"

            badge = {
              "schemaVersion": 1,
              "label": "Foundry verified",
              "message": verified,
              "color": color,
              "cacheSeconds": 3600
            }

            with open(f"dist/{module_id}-foundry-verified-badge.json", "w", encoding="utf-8") as handle:
              json.dump(badge, handle, separators=(",", ":"))

            print(f"Computed badge for {module_id}: verified={verified}, latest_stable={latest_stable}, color={color}")
            PY

            (
              cd "$module_dir"
              zip -r "../dist/${module_id}.zip" . \
                -x "*.DS_Store" \
                -x "*.git*" \
                -x "node_modules/*" \
                -x "tests/*" \
                -x "tools/*" \
                -x ".vscode/*" \
                -x ".copilot/*"
            )
          done

          ls -la dist

      - name: Move modules-latest tag to current commit
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -f modules-latest "$GITHUB_SHA"
          git push --force origin refs/tags/modules-latest

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: modules-latest
          name: Latest Module Assets
          files: dist/*
          overwrite_files: true
          make_latest: true
